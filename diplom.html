<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>√Örsresum√© & Diplomer</title>

  <style>
    :root{
      --red:#d60000;
      --red-dark:#a50000;
      --bg:#f4f4f4;
      --card:#fff;
      --ink:#111;
      --muted:#666;
      --border:#000;
      --radius:10px;
      --shadow:0 2px 12px rgba(0,0,0,0.08);
    }

    *,*::before,*::after{box-sizing:border-box}
    body {
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--ink);
      background-color: var(--bg);
      margin: 0;
      padding: 24px 16px 40px;
      text-align: center;
      line-height: 1.35;
    }
    .logo { display:block; margin:0 auto 10px; width:150px; max-width:60vw; height:auto; }
    h1 { color:var(--red); font-size:clamp(22px,4vw,36px); margin:6px 0 10px; line-height:1.1; }
    .sub{margin:6px 0 14px; color:var(--muted); line-height:1.5; font-size:clamp(13px,3vw,15px);}

    .container{
      width:min(1200px,100%); margin:12px auto 0; background:var(--card); padding:16px;
      border-radius:var(--radius); box-shadow:var(--shadow); text-align:left;
    }

    .status{ color:var(--muted); font-size:12px; margin:8px 0; text-align:left; }
    .error{ color:#b00020; font-weight:600; }

    .table-wrap{ overflow:auto; border-radius:8px; border:1px solid #e6e6e6; }
    table{ width:100%; border-collapse:collapse; font-size:clamp(13px,3vw,14px); table-layout:auto; }
    thead th, td{
      padding:10px 12px; border:1px solid var(--border); text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    thead th{ position:sticky; top:0; background:#fff; z-index:2; font-weight:700; }

    tbody tr:nth-child(even){ background-color:#fafafa; }
    tbody tr:hover{ background-color:#f1f1f1; }

    .loading{ display:none; flex-direction:column; align-items:center; justify-content:center; gap:10px; margin:14px 0; }
    .shark-spinner{ font-size:40px; display:inline-block; animation:spinShark 1s linear infinite; }
    @keyframes spinShark{ 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:12px}
    .card{border:1px solid #e6e6e6;border-radius:10px;padding:14px;background:#fff; }

    @media (max-width:860px){
      .container{ border-radius:12px; padding:12px; }
    }
    @media (max-width:700px){
      .grid{grid-template-columns:1fr;}
      table.responsive-table thead{ 
        border:0; clip:rect(0 0 0 0); height:1px; margin:-1px; overflow:hidden; padding:0; position:absolute; width:1px;
      }
      table.responsive-table tbody tr{
        display:block;
        margin:10px 0 14px;
        border:1px solid #e6e6e6;
        border-radius:10px;
        background:#fff;
      }
      table.responsive-table td{
        display:grid; 
        grid-template-columns: 40% 60%;
        gap:8px;
        text-align:left;
        border:none;
        border-bottom:1px solid #eee;
        padding:10px 12px;
      }
      table.responsive-table td:last-child{ border-bottom:none; }
      table.responsive-table td::before{
        content: attr(data-label);
        font-weight:700;
        color:#333;
      }
    }
  </style>
</head>

<body>
  <img src="https://raw.githubusercontent.com/Joel1993055/Klub-Record2/main/S%C3%98LLER%C3%98D%20SV%C3%98MMEKLUB.png" alt="Klublogo" class="logo" />

  <h1>√Örsresum√© <span id="year-tag"></span></h1>
  <p class="sub">Denne side viser alle klubrekorder sat i det valgte √•r og giver mulighed for at √•bne et diplom for hver rekord.</p>

  <div class="container">
    <div class="loading" aria-busy="true">
      <div class="shark-spinner">ü¶à</div>
      <p>Indl√¶ser data‚Ä¶</p>
    </div>
    <div class="status" id="status" aria-live="polite"></div>
    <div id="summary-root"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /**********************
     * CONFIG
     **********************/
    const sheetUrls = {
      "DRENGE_KORTBANE": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=6811393&single=true&output=csv",
      "DRENGE_LANGBANE": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=778236977&single=true&output=csv",
      "PIGER_KORTBANE":  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=684318980&single=true&output=csv",
      "PIGER_LANGBANE":  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=1936216372&single=true&output=csv"
    };

    const currentYear = new Date().getFullYear();
    document.getElementById("year-tag").textContent = currentYear;

    /***********************
     * UTILS
     ***********************/
    function showLoading(show){
      const ld = document.querySelector(".loading");
      ld.style.display = show ? "flex" : "none";
    }
    function setStatus(msg, isError=false){
      const s = document.getElementById("status");
      s.textContent = msg || "";
      s.classList.toggle("error", !!isError);
    }

    function parseCSV(text){ return Papa.parse(text, { skipEmptyLines: true }).data; }
    async function fetchCSV(url){ const res=await fetch(url); return res.text(); }

    /************************
     * DIPLOMA GENERATOR
     ************************/

    function openDiploma(entry) {
      const year = currentYear;
      const name  = entry.Navn;
      const time  = entry.Tid;
      const loeb  = entry["L√∏b"];
      const alder = entry.Alder;
      const kategori = entry.Kategori;

      let bane = "";
      const upCat = kategori.toUpperCase();
      if (upCat.includes("LANGBANE")) bane = "LANGBANE";
      else if (upCat.includes("KORTBANE")) bane = "KORTBANE";

      const eventLine = bane ? `${loeb} ‚Äì ${alder} √ÖR ‚Äì ${bane}` : `${loeb} ‚Äì ${alder} √ÖR`;

      // LOGO REAL AQU√ç ‚Äî Cambia si quieres PNG
      const logoUrl = "https://raw.githubusercontent.com/Joel1993055/Klub-Record2/main/logo-club-red2.svg";

      const diplomaHtml = `
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <style>
    body{
      font-family:Arial, sans-serif;
      display:flex; flex-direction:column; align-items:center;
      background:#f2f2f2;
      padding:20px;
    }
    .frame{
      width:900px; background:#fff; min-height:500px;
      display:grid; grid-template-columns:220px 1fr;
      box-shadow:0 16px 40px rgba(0,0,0,0.18);
    }
    .left{
      background:#be1e2d;
      padding:30px 20px;
      color:#fff;
      display:flex; flex-direction:column;
      justify-content:space-between; align-items:center;
    }
    .club-logo-img{
      width:120px; height:auto;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,.4));
    }
    .right{ padding:50px 40px; text-align:center; }
    .title{ font-size:32px; color:#be1e2d; letter-spacing:0.14em; margin-bottom:25px; }
    .name{ font-size:30px; font-weight:700; margin-bottom:20px; }
    .time{ font-size:24px; margin-bottom:20px; letter-spacing:0.1em;}
    .event{ font-size:18px; margin-bottom:25px; text-transform:uppercase; letter-spacing:0.12em; }
    .year{ font-size:16px; color:#666; margin-bottom:40px; }

    .download-btn{
      margin-top:25px; padding:10px 20px;
      background:#be1e2d; color:#fff; border:none;
      border-radius:8px; cursor:pointer;
      font-weight:700; letter-spacing:0.08em;
      box-shadow:0 6px 20px rgba(190,30,45,0.4);
    }

    @media print{
      .download-btn{ display:none; }
      body{ background:#fff; padding:0; }
      .frame{ box-shadow:none; }
    }
  </style>
</head>
<body>

  <div class="frame">
    <div class="left">
      <img src="${logoUrl}" class="club-logo-img" />
    </div>

    <div class="right">
      <div class="title">KLUBREKORD</div>
      <div class="name">${name}</div>
      <div class="time">${time}</div>
      <div class="event">${eventLine}</div>
      <div class="year">${year}</div>
    </div>
  </div>

  <button class="download-btn" onclick="window.print()">Download som PDF</button>

</body>
</html>
      `;

      const blob = new Blob([diplomaHtml], {type:"text/html"});
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
    }

    /***********************
     * TABLE + SUMMARY
     ***********************/
    async function buildYearSummary(){
      try{
        showLoading(true);
        const cats = Object.keys(sheetUrls);

        let all = [];
        for (const c of cats){
          const csv = await fetchCSV(sheetUrls[c]);
          const rows = parseCSV(csv);

          // Buscamos filas del a√±o
          const found = [];
          const yearRe = new RegExp("\\b"+currentYear+"\\b");

          rows.forEach(r=>{
            if (r.some(cell=>yearRe.test(cell))){
              found.push({
                Navn: r[1],
                Alder: r[2],
                "L√∏b": r[0],
                Tid: r[3],
                Kategori: c
              })
            }
          });

          all = all.concat(found);
        }

        renderSummaryPage(all);
      }
      catch(err){
        console.error(err);
      }
      finally{
        showLoading(false);
      }
    }

    function renderSummaryPage(entries){
      const root = document.getElementById("summary-root");
      const heads = ["Navn","Alder","L√∏b","Tid","Kategori","Diplom"];
      const trs = entries.map(e => `
<tr>
  <td data-label="Navn">${e.Navn}</td>
  <td data-label="Alder">${e.Alder}</td>
  <td data-label="L√∏b">${e["L√∏b"]}</td>
  <td data-label="Tid">${e.Tid}</td>
  <td data-label="Kategori">${e.Kategori}</td>
  <td><button onclick='openDiploma(${JSON.stringify(e)})'>Diplom</button></td>
</tr>`).join("");

      root.innerHTML = `
        <div class="table-wrap">
          <table class="responsive-table">
            <thead>
              <tr>${heads.map(h=>`<th>${h}</th>`).join("")}</tr>
            </thead>
            <tbody>${trs}</tbody>
          </table>
        </div>
      `;
    }

    buildYearSummary();
  </script>

</body>
</html>
