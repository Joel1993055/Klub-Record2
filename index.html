<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Klubrekorder</title>
  <style>
    :root{
      --red:#d60000;
      --red-dark:#a50000;
      --bg:#f4f4f4;
      --card:#fff;
      --ink:#111;
      --muted:#666;
      --border:#000;
      --highlight:#fff5b1;
    }
    *,*::before,*::after{box-sizing:border-box}
    body {
      font-family: Arial, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color: var(--ink);
      background-color: var(--bg);
      margin: 0;
      padding: 24px 16px 40px;
      text-align: center;
    }
    .logo { display:block; margin:0 auto 10px; width:150px; height:auto; }
    h1 { color:var(--red); font-size:clamp(24px,3vw,36px); margin:6px 0 10px; line-height:1.1; }
    .toolbar { display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:center; margin:12px auto 16px; }
    .button-container { display:flex; flex-wrap:wrap; justify-content:center; gap:8px; }
    button.category-btn{
      padding:10px 14px; font-size:14px; border:1px solid transparent; border-radius:6px;
      background-color:var(--red); color:#fff; cursor:pointer;
      transition:background-color .2s, border-color .2s;
    }
    button.category-btn:hover{ background-color:var(--red-dark); }
    button.category-btn.active{ background:#333; border-color:#000; }
    #btn-summary{ background:#222; }
    #btn-summary:hover{ background:#000; }
    .searchbox{
      display:flex; align-items:center; gap:8px; padding:8px 10px;
      background:var(--card); border:1px solid #ddd; border-radius:8px;
      box-shadow:0 1px 2px rgba(0,0,0,.04); min-width:min(520px,95vw);
    }
    .searchbox input{ width:100%; border:0; outline:0; font-size:14px; background:transparent; color:var(--ink); }
    .container{
      width:min(1200px,100%); margin:12px auto 0; background:var(--card); padding:10px;
      border-radius:10px; box-shadow:0 2px 12px rgba(0,0,0,0.08); overflow:hidden; text-align:left;
    }
    .table-wrap{ overflow:auto; border-radius:8px; border:1px solid #e6e6e6; }
    table{ width:100%; border-collapse:collapse; font-size:14px; }
    caption{ position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0 0 0 0); white-space:nowrap; }
    thead th, td{
      padding:10px 12px; border:1px solid var(--border); text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    thead th{ position:sticky; top:0; background:#fff; z-index:2; font-weight:700; user-select:none; cursor:pointer; }
    thead th .sort-ind{ margin-left:6px; font-size:12px; color:var(--muted); }
    tbody tr:nth-child(even){ background-color:#fafafa; }
    tbody tr:hover{ background-color:#f1f1f1; }
    .test-cell{ background:#ffcccc !important; color:#000; font-weight:bold; }
    .kr-row{ font-weight:bold; }
    .year-highlight{ background:var(--highlight) !important; font-weight:bold; }
    .loading{ display:none; flex-direction:column; align-items:center; justify-content:center; gap:10px; margin:14px 0; }
    .shark-spinner{ font-size:40px; display:inline-block; animation:spinShark 1s linear infinite; }
    @keyframes spinShark{ 0%{transform:rotate(0deg);} 100%{transform:rotate(360deg);} }
    .status{ color:var(--muted); font-size:12px; margin-top:6px; text-align:center; }
    .error{ color:#b00020; font-weight:600; }
    @media (max-width:720px){
      thead th, td{ padding:8px 10px; font-size:13px; }
      .searchbox{ min-width:unset; width:100%; }
    }
  </style>
</head>
<body>
  <img src="https://raw.githubusercontent.com/Joel1993055/Klub-Record2/main/S%C3%98LLER%C3%98D%20SV%C3%98MMEKLUB.png" alt="Klublogo" class="logo" />
  <h1>Klubrekorder</h1>

  <div class="toolbar">
    <div class="button-container" role="tablist" aria-label="Kategorier">
      <button class="category-btn" data-category="DRENGE_KORTBANE" role="tab" aria-selected="false">Drenge Kortbane</button>
      <button class="category-btn" data-category="DRENGE_LANGBANE"  role="tab" aria-selected="false">Drenge Langbane</button>
      <button class="category-btn" data-category="PIGER_KORTBANE"   role="tab" aria-selected="false">Piger Kortbane</button>
      <button class="category-btn" data-category="PIGER_LANGBANE"   role="tab" aria-selected="false">Piger Langbane</button>
      <button id="btn-summary" class="category-btn" type="button" title="Ã…rsresumÃ© af rekorder">Ã…rsresumÃ© <span id="year-tag"></span></button>
    </div>
    <div class="searchbox" aria-label="SÃ¸g i tabellen">
      ðŸ”Ž <input id="search" type="search" placeholder="SÃ¸g i alle kolonnerâ€¦" aria-label="SÃ¸g i tabellen" />
    </div>
  </div>

  <div class="container" aria-live="polite">
    <div class="loading" aria-busy="true">
      <div class="shark-spinner">ðŸ¦ˆ</div>
      <p>IndlÃ¦ser dataâ€¦</p>
    </div>
    <div class="status" id="status" aria-live="polite"></div>
    <div class="table-wrap">
      <table id="records">
        <caption>Klubrekorder â€“ tabel</caption>
      </table>
    </div>
  </div>

  <!-- PapaParse (CSV parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /*** CONFIG (code in English, UI text in Danish) ***/
    const sheetUrls = {
      "DRENGE_KORTBANE": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=555223609&output=csv",
      "DRENGE_LANGBANE": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=1217377815&output=csv",
      "PIGER_KORTBANE":  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=665145950&output=csv",
      "PIGER_LANGBANE":  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=1263870070&output=csv"
    };
    const TEST_REGEX = /\b(50|100|200|400|800|1500)\s(Fri|Bryst|Ryg|IM|Fly)\b/;

    /*** STATE ***/
    let currentCategory = "DRENGE_KORTBANE";
    let fullRows = [];
    let filteredRows = [];
    let sortState = { index: null, dir: 1 };
    const currentYear = new Date().getFullYear();
    document.getElementById("year-tag").textContent = currentYear;

    /*** UTILS ***/
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    function showLoading(show){
      const ld = $(".loading");
      ld.style.display = show ? "flex" : "none";
      ld.setAttribute("aria-busy", show ? "true":"false");
    }
    function setStatus(msg, isError=false){
      const s = $("#status");
      s.textContent = msg || "";
      s.classList.toggle("error", !!isError);
    }
    function debounce(fn, ms=200){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

    // Parse h:mm:ss.cc, m:ss.cc, ss.cc
    function timeToSeconds(txt){
      if (!txt) return NaN;
      const s = String(txt).trim();
      if (!s) return NaN;
      const parts = s.split(":");
      if (parts.length === 1) { return parseFloat(parts[0].replace(",", ".")); }
      let sec = 0;
      for (let i=0; i<parts.length; i++){
        const p = parts[i].replace(",", ".");
        const val = parseFloat(p);
        if (isNaN(val)) return NaN;
        const pow = parts.length - 1 - i;
        sec += val * Math.pow(60, pow);
      }
      return sec;
    }
    function cmpSmart(a, b){
      const ta = (String(a).includes(":")) ? timeToSeconds(a) : NaN;
      const tb = (String(b).includes(":")) ? timeToSeconds(b) : NaN;
      const bothTime = !isNaN(ta) && !isNaN(tb);
      if (bothTime) return ta - tb;
      return String(a).localeCompare(String(b), undefined, { numeric:true, sensitivity:"base" });
    }
    function parseCSV(text){ return Papa.parse(text, { skipEmptyLines: true }).data; }
    async function fetchCSV(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    }

    /*** RENDER ***/
    function renderTable(){
      const table = $("#records");
      if (!fullRows.length){
        table.innerHTML = "<thead></thead><tbody><tr><td>Ingen data.</td></tr></tbody>";
        return;
      }
      const header = (fullRows[1] || []).map(x => String(x||"").replace(/"/g,""));

      // thead
      let thead = "<thead><tr>";
      header.forEach((col, i) => {
        const isTest = TEST_REGEX.test(col);
        const className = isTest ? "test-cell" : "";
        let ind = "";
        if (sortState.index === i) ind = sortState.dir === 1 ? "â–²" : "â–¼";
        thead += `<th class="${className}" data-col="${i}" scope="col" aria-sort="${sortState.index===i ? (sortState.dir===1?'ascending':'descending') : 'none'}">${col} <span class="sort-ind">${ind}</span></th>`;
      });
      thead += "</tr></thead>";

      // tbody
      const yearRegex = new RegExp(`\\b${currentYear}\\b`);
      let tbody = "<tbody>";
      filteredRows.forEach((row) => {
        const rowData = row.map(c => String(c||"").trim());
        const isKR = rowData.some(cell => cell === "KR");
        const rowClass = isKR ? "kr-row" : "";
        const highlight = new Set();
        const emojiAt = new Set();
        rowData.forEach((cell, idx) => {
          if (yearRegex.test(cell)) {
            [idx, idx-1, idx-2].forEach(k => { if (k >= 0 && k < rowData.length) highlight.add(k); });
            const t = idx - 2;
            if (t >= 0 && t < rowData.length) emojiAt.add(t);
          }
        });
        tbody += `<tr class="${rowClass}">`;
        rowData.forEach((cell, idx) => {
          let clean = cell.replace(/"/g,"");
          const isTestCell = TEST_REGEX.test(clean);
          let cls = isTestCell ? "test-cell" : "";
          if (highlight.has(idx)) cls += " year-highlight";
          if (emojiAt.has(idx)) clean = "ðŸ†• " + clean;
          tbody += `<td class="${cls.trim()}">${clean}</td>`;
        });
        tbody += `</tr>`;
      });
      tbody += "</tbody>";

      table.innerHTML = thead + tbody;

      // sort handlers
      $$("#records thead th").forEach(th=>{
        th.addEventListener("click", () => {
          const col = +th.dataset.col;
          if (sortState.index === col) {
            sortState.dir = -sortState.dir;
          } else {
            sortState.index = col;
            sortState.dir = 1;
          }
          filteredRows.sort((a,b)=> sortState.dir * cmpSmart(a[col]||"", b[col]||""));
          renderTable();
        });
      });
    }

    /*** LOAD ***/
    async function loadCategory(cat){
      try{
        currentCategory = cat;
        setActiveButton(cat);
        setStatus("");
        showLoading(true);
        $("#records").innerHTML = "";
        const txt = await fetchCSV(sheetUrls[cat]);
        const data = parseCSV(txt);
        fullRows = data.filter(row => row.some(cell => String(cell||"").trim() !== ""));
        if (fullRows.length < 2){
          setStatus("Ingen data i arket.", true);
          showLoading(false);
          return;
        }
        filteredRows = fullRows.slice(2);
        sortState = { index: null, dir: 1 };
        renderTable();
        showLoading(false);
      } catch(err){
        console.error(err);
        setStatus("Fejl ved indlÃ¦sning af data. PrÃ¸v igen.", true);
        showLoading(false);
      }
    }

    function setActiveButton(cat){
      $$(".category-btn").forEach(b=>{
        const active = b.dataset.category === cat;
        b.classList.toggle("active", active);
        b.setAttribute("aria-selected", active ? "true":"false");
      });
    }

    /*** SUMMARY HELPERS ***/
    function safeCell(rows, r, c){
      if (r < 0 || c < 0) return "";
      if (r >= rows.length) return "";
      const row = rows[r];
      if (!row || c >= row.length) return "";
      return String(row[c] || "").trim();
    }
    function findRowLabel(row){
      for (let j=0; j<Math.min(3,row.length); j++){
        const t = String(row[j]||"").trim();
        if (t) return t;
      }
      return "";
    }
    function parseRowLabelForAge(label){
      const s = String(label||"").toUpperCase();
      const m = s.match(/\b(10|11|12|13|14|15|16|17|18)\b/);
      if (m) return parseInt(m[1], 10);
      if (/\bKR\b/.test(s) || /\bSENIOR\b/.test(s)) return "KR";
      return null;
    }
    function ageToOffset(age){
      if (age === "KR") return 9;
      if (typeof age === "number") return Math.max(1, age - 9);
      return null;
    }

    function collectYearEntriesFromMatrix(rows, categoryLabel, year){
      const entries = [];
      const yearRe = new RegExp(`\\b${year}\\b`);
      const seen = new Set();

      for (let ri=0; ri<rows.length; ri++){
        const row = rows[ri];
        if (!row) continue;

        const rowLabel = findRowLabel(row);
        const ageParsedForOffset = parseRowLabelForAge(rowLabel);
        const offset = ageToOffset(ageParsedForOffset);

        for (let ci=0; ci<row.length; ci++){
          const cell = String(row[ci]||"").trim();
          if (!yearRe.test(cell)) continue;

          // Relative to the year cell
          const time  = safeCell(rows, ri, ci - 1);
          const name  = safeCell(rows, ri, ci - 2);
          const age   = safeCell(rows, ri, 1);        // ALWAYS from column B

          // Event (lÃ¸b)
          let event = "";
          if (offset != null){
            event = safeCell(rows, ri - offset, ci - 2);
          }
          if (!event) {
            event = safeCell(rows, 1, ci - 2) || safeCell(rows, 0, ci - 2);
          }

          const hasCore = time && (name || event);
          if (!hasCore) continue;

          const key = `${categoryLabel}|${name}|${age}|${time}|${event}`;
          if (seen.has(key)) continue;
          seen.add(key);

          entries.push({
            "Navn": name,
            "Alder": age,
            "LÃ¸b": event,
            "Tid": time,
            "Kategori / Bassin": categoryLabel
          });
        }
      }
      return entries;
    }

    async function fetchAllCategories(){
      const cats = Object.keys(sheetUrls);
      const texts = await Promise.all(cats.map(k => fetchCSV(sheetUrls[k]).catch(()=> "")));
      const parsed = texts.map(t => parseCSV(t||"").filter(r => r.some(c => String(c||"").trim()!=="")));
      return cats.map((cat, i) => ({ cat, rows: parsed[i]||[] }));
    }

    function openSummaryPage(entries){
      const total = entries.length;
      entries.sort((a,b)=> (String(a["LÃ¸b"]||"").localeCompare(String(b["LÃ¸b"]||""), undefined, {numeric:true,sensitivity:"base"})) || cmpSmart(a["Tid"]||"", b["Tid"]||""));
      const htmlRows = entries.map(e => `
        <tr>
          <td>${e["Navn"]||""}</td>
          <td>${e["Alder"]||""}</td>
          <td>${e["LÃ¸b"]||""}</td>
          <td>${e["Tid"]||""}</td>
          <td>${e["Kategori"]||""}</td>
        </tr>
      `).join("");

      const w = window.open("", "_blank");
      const doc = w.document;
      doc.open();
      doc.write(`<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Ã…rsresumÃ© ${currentYear}</title>
<style>
  body{font-family:Arial,system-ui,Segoe UI,Roboto,sans-serif;background:#f6f6f6;color:#111;margin:0;padding:20px;}
  h1{margin:0 0 8px}
  .muted{color:#666}
  .wrap{max-width:1100px;margin:0 auto;background:#fff;border:1px solid #e6e6e6;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px;}
  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
  th,td{border:1px solid #000;padding:8px 10px;text-align:center;white-space:nowrap}
  thead th{position:sticky;top:0;background:#fff;z-index:1}
  tr:nth-child(even){background:#fafafa}
  .badge{display:inline-block;background:#111;color:#fff;border-radius:999px;padding:2px 8px;font-size:12px;margin-left:8px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Ã…rsresumÃ© ${currentYear} <span class="badge">${total}</span></h1>
    <div style="overflow:auto">
      <table>
        <thead><tr>
          <th>Navn</th><th>Alder</th><th>LÃ¸b</th><th>Tid</th><th>Kategori</th>
        </tr></thead>
        <tbody>${htmlRows || `<tr><td colspan="5">Ingen registreringer i ${currentYear}.</td></tr>`}</tbody>
      </table>
    </div>
  </div>
</body>
</html>`);
      doc.close();
    }

    async function buildYearSummary(){
      try{
        showLoading(true);
        setStatus("Genererer Ã¥rsresumÃ©â€¦");
        const datasets = await fetchAllCategories();
        let all = [];
        for (const ds of datasets){
          const label = ds.cat.replaceAll("_"," ");
          const entries = collectYearEntriesFromMatrix(ds.rows, label, currentYear);
          all = all.concat(entries);
        }
        openSummaryPage(all);
        setStatus("");
      } catch(e){
        console.error(e);
        setStatus("Kunne ikke generere Ã¥rsresumÃ©. Tjek arkene eller forbindelsen.", true);
      } finally{
        showLoading(false);
      }
    }

    /*** UI EVENTS ***/
    document.getElementById("btn-summary").addEventListener("click", buildYearSummary);

    document.getElementById("search").addEventListener("input", debounce((e)=>{
      const term = (e.target.value || "").toLowerCase();
      filteredRows = fullRows.slice(2).filter(r => r.some(c => String(c||"").toLowerCase().includes(term)));
      renderTable();
    }, 120));

    $$(".category-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const cat = btn.dataset.category;
        if (cat && sheetUrls[cat]) loadCategory(cat);
      });
    });

    /*** INIT ***/
    (function init(){
      const url = new URL(location.href);
      const qcat = url.searchParams.get("cat");
      const firstCat = (qcat && sheetUrls[qcat]) ? qcat : "DRENGE_KORTBANE";
      // set active style
      $$(".category-btn").forEach(b=>{
        const active = b.dataset.category === firstCat;
        b.classList.toggle("active", active);
        b.setAttribute("aria-selected", active ? "true":"false");
      });
      loadCategory(firstCat);
    })();
  </script>
</body>
</html>


