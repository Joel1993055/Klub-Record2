<!DOCTYPE html>
<html lang="da">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>S√∏ller√∏d Sv√∏mmeklub ‚Äì Klubrekorder</title>

  <!-- Fuente Inter -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --red:#d60000;
      --red-dark:#a50000;
      --bg:#f4f4f4;
      --card:#fff;
      --ink:#111;
      --muted:#666;
      --border:#dcdcdc;
      --highlight:#fff5b1;
      --row-alt:#f9f9fb;
      --header:#ffffff;
      --shadow:0 2px 10px rgba(0,0,0,.06);
      --shadow-soft:0 1px 6px rgba(0,0,0,.08);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0f1115;
        --card:#161a21;
        --header:#141820;
        --ink:#eaeef7;
        --muted:#98a2b3;
        --border:#2b3140;
        --row-alt:#11161e;
        --highlight:#2a2f3c;
        --shadow:0 2px 10px rgba(0,0,0,.35);
        --shadow-soft:0 1px 6px rgba(0,0,0,.35);
      }
    }

    *,*::before,*::after{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--ink);
      background: var(--bg);
      margin: 0;
    }

    /* Header institucional */
    .topbar{
      position: sticky; top: 0; z-index: 10;
      display:flex; align-items:center; gap:14px;
      background: var(--header);
      box-shadow: var(--shadow);
      padding: 10px 16px;
    }
    .toplogo{ height:40px; width:auto; display:block }
    .titlewrap{ display:flex; flex-direction:column; gap:2px }
    .title{ margin:0; font-size:clamp(18px, 2.4vw, 22px); line-height:1.2; font-weight:700; color:var(--red) }
    .subtitle{ margin:0; color:var(--muted); font-size:13px }

    /* Layout principal */
    .page{
      max-width: 1200px;
      margin: 16px auto;
      padding: 0 12px 28px;
    }

    /* Toolbar mejorada */
    .toolbar{
      display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between;
      gap:12px; margin: 8px 0 14px;
    }
    .tabs{ display:flex; flex-wrap:wrap; gap:8px; align-items:center }
    .tab{
      padding:10px 14px; font-size:14px; border:1px solid var(--border); border-radius:999px;
      background: var(--card); color:var(--ink); cursor:pointer;
      transition: transform .15s ease, box-shadow .15s ease, background .2s ease;
      box-shadow: var(--shadow-soft);
    }
    .tab:hover{ transform: translateY(-1px) }
    .tab.active{
      background: var(--red); color:#fff; border-color: transparent;
      box-shadow: 0 4px 10px rgba(214,0,0,.25);
    }
    #btn-summary{ background:#222; color:#fff; border-color:transparent }
    #btn-summary:hover{ transform: translateY(-1px); box-shadow:0 4px 10px rgba(0,0,0,.25) }

    .searchbox{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px; min-width:min(540px, 95vw);
      background: var(--card); border:1px solid var(--border); border-radius:10px;
      box-shadow: var(--shadow-soft);
    }
    .searchbox input{
      width:100%; border:0; outline:0; font-size:14px; background:transparent; color:var(--ink);
    }

    /* Card contenedor */
    .container{
      background: var(--card); border:1px solid var(--border);
      border-radius:14px; box-shadow: var(--shadow); overflow:hidden;
    }

    /* Estado / loading */
    .loading{ display:none; align-items:center; justify-content:center; gap:10px; padding:16px; border-bottom:1px solid var(--border); }
    .shark{ font-size:22px; display:inline-block; animation:spin 1s linear infinite; }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }
    .status{ color:var(--muted); font-size:13px; padding:10px 12px; }
    .error{ color:#ff5c7c; font-weight:600 }

    /* Tabla refinada */
    .table-wrap{ overflow:auto; }
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:14px; }
    thead th{
      position: sticky; top: 0; background: var(--header); z-index: 2;
      text-align:center; padding:10px 12px; white-space:nowrap;
      border-bottom:1px solid var(--border); border-right:1px solid var(--border);
      font-weight:700; user-select:none; cursor:pointer;
      box-shadow: 0 1px 0 rgba(0,0,0,.04);
    }
    thead th:last-child{ border-right:0 }
    tbody td{
      text-align:center; padding:10px 12px; white-space:nowrap;
      border-bottom:1px solid var(--border); border-right:1px solid var(--border);
    }
    tbody tr:nth-child(even){ background: var(--row-alt) }
    tbody tr:hover{ filter: brightness(0.98) }
    tbody td:last-child{ border-right:0 }

    .test-cell{ background: #ffe1e1 !important; color:#000; font-weight:700 }
    @media (prefers-color-scheme: dark){
      .test-cell{ background:#2a1a1a !important; color:#fff }
    }
    .kr-row{ font-weight:700 }
    .year-highlight{ background: var(--highlight) !important; font-weight:700 }

    /* Utilidades */
    .hidden{ display:none !important }

    /* Responsive */
    @media (max-width: 820px){
      .searchbox{ min-width: unset; width:100% }
      .toolbar{ gap:10px }
      .tabs{ width:100%; order:2; justify-content:center }
      .searchbox{ order:3 }
      #btn-summary{ order:1 }
    }
  </style>
</head>

<body>
  <!-- Header institucional -->
  <header class="topbar">
    <img class="toplogo" alt="S√∏ller√∏d logo"
         src="https://raw.githubusercontent.com/Joel1993055/Klub-Record2/main/S%C3%98LLER%C3%98D%20SV%C3%98MMEKLUB.png"/>
    <div class="titlewrap">
      <h1 class="title">S√∏ller√∏d Sv√∏mmeklub ‚Äì Klubrekorder</h1>
      <p class="subtitle">Opdaterede klubrekorder. S√∏g, orden√©r og se √•rets h√∏jdepunkter.</p>
    </div>
  </header>

  <main class="page">
    <!-- Toolbar -->
    <div class="toolbar" role="navigation" aria-label="V√¶rkt√∏jslinje">
      <div class="tabs" role="tablist" aria-label="Kategorier">
        <button class="tab" data-category="DRENGE_KORTBANE" role="tab" aria-selected="false">Drenge Kortbane</button>
        <button class="tab" data-category="DRENGE_LANGBANE"  role="tab" aria-selected="false">Drenge Langbane</button>
        <button class="tab" data-category="PIGER_KORTBANE"   role="tab" aria-selected="false">Piger Kortbane</button>
        <button class="tab" data-category="PIGER_LANGBANE"   role="tab" aria-selected="false">Piger Langbane</button>
        <button id="btn-summary" class="tab" type="button" title="√Örsresum√© af rekorder">
          √Örsresum√© <span id="year-tag"></span>
        </button>
      </div>

      <div class="searchbox" aria-label="S√∏g i tabellen">
        üîé <input id="search" type="search" placeholder="S√∏g efter navn eller l√∏b‚Ä¶" aria-label="S√∏g i tabellen"/>
      </div>
    </div>

    <!-- Contenido -->
    <section class="container" aria-live="polite">
      <div class="loading" aria-busy="true">
        <span class="shark">ü¶à</span>
        <span>Henter klubrekorder ‚Äì det tager kun et √∏jeblik‚Ä¶</span>
      </div>
      <div class="status" id="status" aria-live="polite"></div>
      <div class="table-wrap">
        <table id="records" aria-label="Klubrekorder tabel">
          <caption class="hidden">Klubrekorder ‚Äì tabel</caption>
          <!-- renderizado por JS -->
        </table>
      </div>
    </section>
  </main>

  <!-- PapaParse (CSV parsing) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /*** CONFIG ***/
    const sheetUrls = {
      "DRENGE_KORTBANE": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=555223609&output=csv",
      "DRENGE_LANGBANE": "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=1217377815&output=csv",
      "PIGER_KORTBANE":  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=665145950&output=csv",
      "PIGER_LANGBANE":  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRfGmunD4CHr8OxM1R2E5MpHWMa2lzRiG1A1MvnoLvmbDxVww3zsxe0hGgoClvJGQ/pub?gid=1263870070&output=csv"
    };
    const TEST_REGEX = /\b(50|100|200|400|800|1500)\s(Fri|Bryst|Ryg|IM|Fly)\b/;

    /*** STATE ***/
    let currentCategory = "DRENGE_KORTBANE";
    let fullRows = [];
    let filteredRows = [];
    let sortState = { index: null, dir: 1 };
    const currentYear = new Date().getFullYear();
    document.getElementById("year-tag").textContent = currentYear;

    /*** UTILS ***/
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));
    const show = (el, v) => el.classList.toggle("hidden", !v);

    function showLoading(v){
      const ld = document.querySelector(".loading");
      show(ld, v);
      ld.setAttribute("aria-busy", v ? "true" : "false");
    }
    function setStatus(msg, isError=false){
      const s = $("#status");
      s.textContent = msg || "";
      s.classList.toggle("error", !!isError);
    }
    function debounce(fn, ms=220){ let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); }; }

    // Parse h:mm:ss.cc, m:ss.cc, ss.cc
    function timeToSeconds(txt){
      if (!txt) return NaN;
      const s = String(txt).trim();
      if (!s) return NaN;
      const parts = s.split(":");
      if (parts.length === 1) { return parseFloat(parts[0].replace(",", ".")); }
      let sec = 0;
      for (let i=0; i<parts.length; i++){
        const p = parts[i].replace(",", ".");
        const val = parseFloat(p);
        if (isNaN(val)) return NaN;
        const pow = parts.length - 1 - i;
        sec += val * Math.pow(60, pow);
      }
      return sec;
    }
    function cmpSmart(a, b){
      const ta = (String(a).includes(":")) ? timeToSeconds(a) : NaN;
      const tb = (String(b).includes(":")) ? timeToSeconds(b) : NaN;
      const bothTime = !isNaN(ta) && !isNaN(tb);
      if (bothTime) return ta - tb;
      return String(a).localeCompare(String(b), "da", { numeric:true, sensitivity:"base" });
    }
    function parseCSV(text){ return Papa.parse(text, { skipEmptyLines: true }).data; }
    async function fetchCSV(url){
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return await res.text();
    }

    /*** RENDER ***/
    function renderTable(){
      const table = $("#records");
      if (!fullRows.length){
        table.innerHTML = "<thead></thead><tbody><tr><td>Ingen data.</td></tr></tbody>";
        return;
      }
      const header = (fullRows[1] || []).map(x => String(x||"").replace(/"/g,""));

      // thead
      let thead = "<thead><tr>";
      header.forEach((col, i) => {
        const isTest = TEST_REGEX.test(col);
        const className = isTest ? "test-cell" : "";
        let ind = "";
        if (sortState.index === i) ind = sortState.dir === 1 ? "‚ñ≤" : "‚ñº";
        thead += `<th class="${className}" data-col="${i}" scope="col" aria-sort="${sortState.index===i ? (sortState.dir===1?'ascending':'descending') : 'none'}">${col} <span class="sort-ind">${ind}</span></th>`;
      });
      thead += "</tr></thead>";

      // tbody
      const yearRegex = new RegExp(`\\b${currentYear}\\b`);
      let tbody = "<tbody>";
      filteredRows.forEach((row) => {
        const rowData = row.map(c => String(c||"").trim());
        const isKR = rowData.some(cell => cell === "KR");
        const rowClass = isKR ? "kr-row" : "";
        const highlight = new Set();
        const emojiAt = new Set();
        rowData.forEach((cell, idx) => {
          if (yearRegex.test(cell)) {
            [idx, idx-1, idx-2].forEach(k => { if (k >= 0 && k < rowData.length) highlight.add(k); });
            const t = idx - 2;
            if (t >= 0 && t < rowData.length) emojiAt.add(t);
          }
        });
        tbody += `<tr class="${rowClass}">`;
        rowData.forEach((cell, idx) => {
          let clean = cell.replace(/"/g,"");
          const isTestCell = TEST_REGEX.test(clean);
          let cls = isTestCell ? "test-cell" : "";
          if (highlight.has(idx)) cls += " year-highlight";
          if (emojiAt.has(idx)) clean = "üÜï " + clean;
          tbody += `<td class="${cls.trim()}">${clean}</td>`;
        });
        tbody += `</tr>`;
      });
      tbody += "</tbody>";

      table.innerHTML = thead + tbody;

      // sort handlers
      $$("#records thead th").forEach(th=>{
        th.addEventListener("click", () => {
          const col = +th.dataset.col;
          if (sortState.index === col) {
            sortState.dir = -sortState.dir;
          } else {
            sortState.index = col;
            sortState.dir = 1;
          }
          filteredRows.sort((a,b)=> sortState.dir * cmpSmart(a[col]||"", b[col]||""));
          renderTable();
        });
      });
    }

    /*** LOAD ***/
    async function loadCategory(cat){
      try{
        currentCategory = cat;
        setActiveTab(cat);
        setStatus("");
        showLoading(true);
        $("#records").innerHTML = "";
        const txt = await fetchCSV(sheetUrls[cat]);
        const data = parseCSV(txt);
        fullRows = data.filter(row => row.some(cell => String(cell||"").trim() !== ""));
        if (fullRows.length < 2){
          setStatus("Ingen data i arket.", true);
          showLoading(false);
          return;
        }
        filteredRows = fullRows.slice(2);
        sortState = { index: null, dir: 1 };
        renderTable();
      } catch(err){
        console.error(err);
        setStatus("Fejl ved indl√¶sning af data. Pr√∏v igen.", true);
      } finally {
        showLoading(false);
      }
    }

    function setActiveTab(cat){
      $$(".tab").forEach(b=>{
        const active = b.dataset.category === cat;
        b.classList.toggle("active", active);
        b.setAttribute("aria-selected", active ? "true":"false");
      });
    }

    /*** SUMMARY HELPERS ***/
    const safeCell = (rows, r, c) => (r<0||c<0||r>=rows.length||!rows[r]||c>=rows[r].length) ? "" : String(rows[r][c]||"").trim();
    function findRowLabel(row){ for (let j=0; j<Math.min(3,row.length); j++){ const t=String(row[j]||"").trim(); if(t) return t; } return ""; }
    function parseRowLabelForAge(label){
      const s = String(label||"").toUpperCase();
      const m = s.match(/\b(10|11|12|13|14|15|16|17|18)\b/);
      if (m) return parseInt(m[1], 10);
      if (/\bKR\b/.test(s) || /\bSENIOR\b/.test(s)) return "KR";
      return null;
    }
    function ageToOffset(age){ if (age === "KR") return 9; if (typeof age === "number") return Math.max(1, age - 9); return null; }

    function collectYearEntriesFromMatrix(rows, categoryLabel, year){
      const entries = [];
      const yearRe = new RegExp(`\\b${year}\\b`);
      const seen = new Set();

      for (let ri=0; ri<rows.length; ri++){
        const row = rows[ri];
        if (!row) continue;

        const rowLabel = findRowLabel(row);
        const ageParsedForOffset = parseRowLabelForAge(rowLabel);
        const offset = ageToOffset(ageParsedForOffset);

        for (let ci=0; ci<row.length; ci++){
          const cell = String(row[ci]||"").trim();
          if (!yearRe.test(cell)) continue;

          const time  = safeCell(rows, ri, ci - 1);
          const name  = safeCell(rows, ri, ci - 2);
          const age   = safeCell(rows, ri, 1);     // ALWAYS from column B

          // Event (l√∏b)
          let event = "";
          if (offset != null) event = safeCell(rows, ri - offset, ci - 2);
          if (!event) event = safeCell(rows, 1, ci - 2) || safeCell(rows, 0, ci - 2);

          const hasCore = time && (name || event);
          if (!hasCore) continue;

          const key = `${categoryLabel}|${name}|${age}|${time}|${event}`;
          if (seen.has(key)) continue;
          seen.add(key);

          entries.push({ "Navn": name, "Alder": age, "L√∏b": event, "Tid": time, "Kategori": categoryLabel });
        }
      }
      return entries;
    }

    async function fetchAllCategories(){
      const cats = Object.keys(sheetUrls);
      const texts = await Promise.all(cats.map(k => fetchCSV(sheetUrls[k]).catch(()=> "")));
      const parsed = texts.map(t => parseCSV(t||"").filter(r => r.some(c => String(c||"").trim()!=="")));
      return cats.map((cat, i) => ({ cat, rows: parsed[i]||[] }));
    }

    function openSummaryPage(entries){
      const total = entries.length;

      // Ordenar por nombre (Navn); si empata, por L√∏b y luego por tiempo
      const byName = (a, b) =>
        String(a["Navn"]||"").localeCompare(String(b["Navn"]||""), "da", { sensitivity:"base" }) ||
        String(a["L√∏b"]||"").localeCompare(String(b["L√∏b"]||""), "da", { numeric:true, sensitivity:"base" }) ||
        cmpSmart(a["Tid"]||"", b["Tid"]||"");

      // Partici√≥n por g√©nero y orden
      const isDrenge = e => String(e["Kategori"]||"").toUpperCase().startsWith("DRENGE");
      const isPiger  = e => String(e["Kategori"]||"").toUpperCase().startsWith("PIGER");
      const drengeEntries = entries.filter(isDrenge).sort(byName);
      const pigerEntries  = entries.filter(isPiger).sort(byName);

      // Estad√≠sticas simples
      const uniqueNames = (rows)=> Array.from(new Set(rows.map(r => (r["Navn"]||"").trim()).filter(Boolean)));
      const topSwimmers = (rows)=>{
        const map = new Map();
        rows.forEach(r=>{
          const k = (r["Navn"]||"").trim();
          if(!k) return;
          map.set(k, (map.get(k)||0)+1);
        });
        return Array.from(map.entries()).sort((a,b)=> b[1]-a[1]).slice(0,5);
      };

      const stats = {
        total,
        drenge: drengeEntries.length,
        piger: pigerEntries.length,
        unicos: uniqueNames(entries).length,
        top5Drenge: topSwimmers(drengeEntries),
        top5Piger: topSwimmers(pigerEntries)
      };

      const renderTable = (rows) => {
        if (!rows.length) return `<div class="empty">Ingen registreringer i ${currentYear}.</div>`;
        const trs = rows.map(e => `
          <tr>
            <td>${e["Navn"]||""}</td>
            <td>${e["Alder"]||""}</td>
            <td>${e["L√∏b"]||""}</td>
            <td>${e["Tid"]||""}</td>
            <td>${e["Kategori"]||""}</td>
          </tr>
        `).join("");
        return `
          <div class="table-wrap">
            <table>
              <thead><tr>
                <th>Navn</th><th>Alder</th><th>L√∏b</th><th>Tid</th><th>Kategori</th>
              </tr></thead>
              <tbody>${trs}</tbody>
            </table>
          </div>
        `;
      };

      const w = window.open("", "_blank", "noopener,noreferrer");
      const doc = w.document;
      doc.open();
      doc.write(`<!doctype html>
<html lang="da">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>√Örsresum√© ${currentYear}</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --red:#d60000; --ink:#111; --muted:#666; --bg:#f6f6f6; --card:#fff; --border:#dcdcdc;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0f1115; --card:#161a21; --ink:#eaeef7; --muted:#98a2b3; --border:#2b3140; }
  }
  *{box-sizing:border-box}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:16px;}
  .wrap{max-width:1200px;margin:0 auto;background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px;}
  .header{display:flex;align-items:center;gap:12px;margin-bottom:8px}
  .logo{width:64px;height:auto}
  h1{margin:0;color:var(--red);font-size:22px}
  .sub{margin:6px 0 12px;color:var(--muted);font-size:14px;line-height:1.5}
  .meta{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 10px}
  .badge{display:inline-flex;align-items:center;gap:6px;background:#111;color:#fff;border-radius:999px;padding:4px 10px;font-size:12px}
  .actions{margin-left:auto}
  .btn{border:1px solid var(--border);border-radius:8px;background:#111;color:#fff;padding:6px 10px;font-size:13px;cursor:pointer}
  .btn:hover{filter:brightness(0.95)}
  .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin:8px 0 14px}
  .stat{border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff0}
  .stat h3{margin:0 0 6px;font-size:13px;color:var(--muted)}
  .stat .big{font-size:20px;font-weight:700}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px}
  .card{border:1px solid var(--border);border-radius:10px;padding:12px;background:#fff0}
  .card h2{margin:0 0 8px;font-size:16px}
  .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:8px}
  table{width:100%;border-collapse:separate;border-spacing:0;font-size:14px}
  thead th{position:sticky;top:0;background:#fff;color:#111;border-bottom:1px solid var(--border);padding:8px 10px;text-align:center}
  tbody td{border-bottom:1px solid var(--border);padding:8px 10px;text-align:center;white-space:nowrap}
  tr:nth-child(even){background:#f9f9fb}
  .empty{color:var(--muted);font-style:italic;border:1px dashed var(--border);border-radius:8px;padding:16px;text-align:center}
  @media (prefers-color-scheme: dark){
    thead th{background:#1b1f29;color:#eaeef7}
    tr:nth-child(even){background:#11161e}
  }
  @media (max-width:860px){ .grid{grid-template-columns:1fr;} .logo{width:56px;} .stats{grid-template-columns:1fr 1fr 1fr;} }
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <img class="logo" alt="Klublogo" src="https://raw.githubusercontent.com/Joel1993055/Klub-Record2/main/S%C3%98LLER%C3%98D%20SV%C3%98MMEKLUB.png"/>
      <div>
        <h1>√Örsresum√© ${currentYear} <span class="badge" title="Antal klubrekorder i det aktuelle √•r">üî¥ ${total} rekorder</span></h1>
        <div class="sub">
          Dette dokument viser alle klubrekorder sat i ${currentYear}. Tallet i m√¶rket angiver det samlede antal rekorder opn√•et i l√∏bet af √•ret.
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="window.print()">üñ®Ô∏è Print / PDF</button>
      </div>
    </div>

    <div class="stats">
      <div class="stat">
        <h3>Totalt i √•r</h3>
        <div class="big">${stats.total}</div>
      </div>
      <div class="stat">
        <h3>Drenge</h3>
        <div class="big">${stats.drenge}</div>
      </div>
      <div class="stat">
        <h3>Piger</h3>
        <div class="big">${stats.piger}</div>
      </div>
      <div class="stat">
        <h3>Unikke sv√∏mmere</h3>
        <div class="big">${stats.unicos}</div>
      </div>
      <div class="stat">
        <h3>Top Drenge (5)</h3>
        <div>${stats.top5Drenge.map(([n,c])=>`${n} (${c})`).join(" ¬∑ ") || "‚Äî"}</div>
      </div>
      <div class="stat">
        <h3>Top Piger (5)</h3>
        <div>${stats.top5Piger.map(([n,c])=>`${n} (${c})`).join(" ¬∑ ") || "‚Äî"}</div>
      </div>
    </div>

    <div class="grid">
      <section class="card" aria-labelledby="drenge-title">
        <h2 id="drenge-title">Drenge</h2>
        ${renderTable(drengeEntries)}
      </section>

      <section class="card" aria-labelledby="piger-title">
        <h2 id="piger-title">Piger</h2>
        ${renderTable(pigerEntries)}
      </section>
    </div>
  </div>
</body>
</html>`);
      doc.close();
    }

    async function buildYearSummary(){
      try{
        showLoading(true);
        setStatus("Genererer √•rsresum√©‚Ä¶");
        const datasets = await fetchAllCategories();
        let all = [];
        for (const ds of datasets){
          const label = ds.cat.replaceAll("_"," ");
          const entries = collectYearEntriesFromMatrix(ds.rows, label, currentYear);
          all = all.concat(entries);
        }
        openSummaryPage(all);
        setStatus("");
      } catch(e){
        console.error(e);
        setStatus("Kunne ikke generere √•rsresum√©. Tjek arkene eller forbindelsen.", true);
      } finally{
        showLoading(false);
      }
    }

    /*** UI EVENTS ***/
    document.getElementById("btn-summary").addEventListener("click", buildYearSummary);

    document.getElementById("search").addEventListener("input", debounce((e)=>{
      const term = (e.target.value || "").toLowerCase();
      filteredRows = fullRows.slice(2).filter(r => r.some(c => String(c||"").toLowerCase().includes(term)));
      renderTable();
    }));

    $$(".tab").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const cat = btn.dataset.category;
        if (cat && sheetUrls[cat]) loadCategory(cat);
      });
    });

    /*** INIT ***/
    (function init(){
      const url = new URL(location.href);
      const qcat = url.searchParams.get("cat");
      const firstCat = (qcat && sheetUrls[qcat]) ? qcat : "DRENGE_KORTBANE";
      $$(".tab").forEach(b=>{
        const active = b.dataset.category === firstCat;
        b.classList.toggle("active", active);
        b.setAttribute("aria-selected", active ? "true":"false");
      });
      loadCategory(firstCat);
    })();
  </script>
</body>
</html>
